**1. Repositorios que el Agent debe crear s√≠ o s√≠**

Estructura exacta y final (usar estos nombres):

/vecino-alerta-app         // Flutter ‚Äì Aplicaci√≥n m√≥vil
/vecino-alerta-backend     // Firebase Cloud Functions (Node 20)
/vecino-alerta-panel       // React + Vite (Panel Web del Comit√©)
/vecino-alerta-docs        // Documentaci√≥n t√©cnica, arquitectura y manuales

**2. Flujo de trabajo obligatorio para el Agent**

Crear los 4 repositorios.

Configurar Firebase Project:

Firestore

Authentication (PhoneAuth)

Cloud Functions

AppCheck

Cloud Messaging

Implementar la app m√≥vil EXACTAMENTE como se indica en el MD.

Implementar el backend EXACTAMENTE con las funciones descritas.

Implementar el panel del comit√© (mapa, anal√≠ticas y reportes PDF).

Configurar CI/CD:

Vercel para panel

Flutter build pipelines (Android + iOS)

Firebase deploy autom√°tico

Generar documentaci√≥n en /vecino-alerta-docs.

**3. Arquitectura Firebase que el Agent debe desplegar**

El Agent debe ejecutar esta arquitectura:

Firestore
  /barrios/{barrioId}
     nombre
     logo
     geofence_radius
     sirena_device
     createdAt

  /barrios/{barrioId}/usuarios/{uid}
     name
     phone
     isGuardian
     createdAt
     pushToken
     direccionAprox

  /barrios/{barrioId}/incidentes/{incidenteId}
     type
     location
     timestamp
     confirmedReal
     uid
     resolved
     reportDetails?

  /barrios/{barrioId}/analytics/{docId}
     heatmap
     horasPico
     updatedAt


El Agent debe aplicar reglas de seguridad Firestore:

allow read, write: if request.auth.token.barrioId == barrioId;


Y debe a√±adir:

App Check

Rate Limits

Validaci√≥n de GPS

4. Especificaciones Funcionales y de Seguridad (CR√çTICO)

‚úÖ 4.1. Matriz de Roles y Permisos
El sistema implementa un control de acceso estricto basado en 4 roles (RBAC).

| Permiso / Acci√≥n | üîµ Vecino | üü¢ Comit√© | üü† Hardware Mgr | üî¥ SuperAdmin |
| :--- | :---: | :---: | :---: | :---: |
| **Activar Bot√≥n P√°nico** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| **Reporte Silencioso** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| **Ver Mapa de Calor** | ‚ùå | ‚úÖ | ‚ùå | ‚úÖ (Global) |
| **Gesti√≥n de Usuarios** | ‚ùå | ‚úÖ (Su barrio) | ‚ùå | ‚úÖ (Global) |
| **Configurar Sirena (WiFi/API)** | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ |
| **Activar Sirena (Manual)** | ‚ùå | ‚úÖ | ‚úÖ (Test) | ‚úÖ (Test) |
| **Crear/Borrar Barrios** | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| **Ver Logs T√©cnicos** | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ |

‚úÖ 4.2. Integraci√≥n de Sirenas y Hardware
El sistema es agn√≥stico al hardware, soportando m√∫ltiples protocolos mediante adaptadores en Cloud Functions.

**Tabla de Compatibilidad:**
| Marca | Protocolo | Seguridad | Latencia |
| :--- | :--- | :--- | :--- |
| **Tuya / Smart Life** | HTTP API | Token OAuth | 1-2s |
| **Sonoff (eWeLink)** | HTTP / LAN | AppID / API Key | <1s (LAN) |
| **Shelly** | Webhooks | Basic Auth | <500ms |
| **DIY (ESP32)** | MQTT / POST | Token Propio | <500ms |

**Seguridad de la API de Sirena:**
- **Protocolo:** HTTPS obligatorio para llamadas externas.
- **Manejo de Errores:** Reintento autom√°tico (max 3 intentos) en caso de timeout.
- **Anti-Abuso:**
    - **Rate Limiting:** M√°x 1 activaci√≥n cada 60s por barrio (salvo cancelaci√≥n).
    - **Bloqueo:** Si un dispositivo falla >10 veces seguidas, se marca como `offline` y notifica al Comit√©.
    - **Logs:** Registro inmutable de cada activaci√≥n (`/barrios/{id}/sirena_logs`).

‚úÖ 4.3. L√≥gica del Bot√≥n de P√°nico (Bot√≥n Rojo)
El n√∫cleo del sistema. Debe funcionar con latencia m√≠nima y alta fiabilidad.

**Estados Visuales en App:**
1.  **Idle (Reposo):** Bot√≥n rojo visible.
2.  **Countdown (Pre-alarma):** 3 segundos de cuenta regresiva (cancelable).
3.  **Active (Alarma):** Pantalla roja pulsante, sirena sonando (60s).
4.  **Cooldown:** 30s de espera antes de permitir nueva activaci√≥n (evita spam).

**Comportamiento T√©cnico:**
- **Latencia Esperada:** < 2 segundos desde confirmaci√≥n hasta sonido f√≠sico.
- **Offline:** Si no hay internet, la app muestra error inmediato y sugiere llamar al 911. (No hay "store & forward" para emergencias cr√≠ticas).
- **Activaci√≥n Simult√°nea:** Si dos vecinos activan a la vez, el sistema mantiene la alarma activa y registra ambos eventos.

‚úÖ 4.4. Ciclo de Vida del Incidente
Todo evento sigue un flujo de estados estricto para garantizar trazabilidad.

`PENDIENTE` (Cuenta regresiva) ‚Üí `REAL` (Confirmado) ‚Üí `RESUELTO` (Comit√© cierra) ‚Üí `ARCHIVADO` (30 d√≠as)

- **Creaci√≥n:** Al terminar el countdown.
- **Actualizaci√≥n:** El Comit√© puede agregar notas ("Falsa alarma", "Polic√≠a en camino").
- **Cierre:** Manual por Comit√© o autom√°tico tras 2 horas.
- **Eliminaci√≥n:** Datos sensibles (ubicaci√≥n exacta) se borran/anonimizan a los 30 d√≠as.

‚úÖ 4.5. Flujo de Guardianes
Los "Guardianes" son vecinos de confianza designados para respuesta r√°pida.

1.  **Asignaci√≥n:** El Comit√© selecciona UIDs espec√≠ficos en `/barrios/{id}/guardianes`.
2.  **Notificaci√≥n Prioritaria:**
    - Alerta cr√≠tica (sonido fuerte) incluso en "No Molestar" (usando canales de notificaci√≥n cr√≠tica en iOS/Android).
    - Reciben ubicaci√≥n exacta del incidente.
3.  **Fallo de Cobertura:** Si el sistema detecta < 2 guardianes activos (por heartbeat), env√≠a notificaci√≥n est√°ndar a *todo* el barrio como respaldo.

‚úÖ 4.6. Privacidad y Protecci√≥n de Datos
El sistema est√° dise√±ado bajo el principio de "Privacy by Design".

- **Datos Almacenados:** Nombre, Tel√©fono, Direcci√≥n aproximada (para geofence), Token FCM.
- **Datos NO Almacenados:** Historial de ubicaci√≥n en tiempo real, audio ambiente, contactos de la agenda.
- **Retenci√≥n:** Los incidentes se anonimizan a los 30 d√≠as (se borra la referencia al UID y la ubicaci√≥n exacta).
- **Borrado:** El usuario puede solicitar "Eliminar mi cuenta" desde la app, lo que dispara una Cloud Function que borra sus datos de `/usuarios` y `/barrios`.

‚úÖ 4.7. Seguridad y Reglas Firestore Completas
Reglas de seguridad robustas para prevenir accesos no autorizados.

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Funci√≥n auxiliar para verificar roles
    function hasRole(role) {
      return request.auth.token.role == role;
    }

    // 1. Barrios: Solo SuperAdmin crea, Comit√© lee su barrio
    match /barrios/{barrioId} {
      allow create: if hasRole('superadmin');
      allow read: if hasRole('superadmin') || (request.auth.token.barrioId == barrioId);
      allow update: if hasRole('superadmin') || (hasRole('comite') && request.auth.token.barrioId == barrioId);
      
      // 2. Sirenas: Solo Hardware Manager y SuperAdmin tocan configuraci√≥n
      match /sirena/{docId} {
        allow read: if request.auth.token.barrioId == barrioId;
        allow write: if (hasRole('hardware_manager') || hasRole('superadmin')) && request.auth.token.barrioId == barrioId;
      }

      // 3. Incidentes: Vecino crea, Comit√© gestiona
      match /incidentes/{incidenteId} {
        allow create: if request.auth.token.barrioId == barrioId; // Cualquier vecino del barrio
        allow read: if request.auth.token.barrioId == barrioId;
        allow update: if hasRole('comite') && request.auth.token.barrioId == barrioId; // Solo comit√© cierra/comenta
      }
      
      // 4. Usuarios: Cada uno lee su perfil, Comit√© lee todos los de su barrio
      match /usuarios/{uid} {
        allow read: if request.auth.uid == uid || (hasRole('comite') && request.auth.token.barrioId == barrioId);
        allow write: if request.auth.uid == uid; // Solo editar propios datos (foto/nombre)
      }
    }
  }
}
```

‚úÖ 4.8. Panel de Administraci√≥n Nacional (SuperAdmin)
Herramienta centralizada para el mantenimiento del ecosistema.

- **M√©tricas Globales:** Total de barrios activos, incidentes √∫ltimas 24h, estado de salud de sirenas (online/offline).
- **Gesti√≥n de Barrios:** Alta de nuevos barrios, generaci√≥n de c√≥digos de invitaci√≥n para Comit√©s.
- **Herramientas de Soporte:**
    - `Test Siren`: Dispara prueba de 2s en cualquier barrio.
    - `Reset Admin`: Restablece acceso al Comit√© si pierden el tel√©fono.
    - `Audit Log`: Ver qui√©n modific√≥ qu√© configuraci√≥n cr√≠tica.

‚úÖ 4.9. Estrategia de Testing y QA
El Agent debe generar tests para garantizar estabilidad.

- **Unit Tests (Jest):** Para todas las Cloud Functions (especialmente `triggerEmergency` y l√≥gica de roles).
- **Integration Tests:** Simular flujo completo: `Crear Incidente` -> `Firestore Trigger` -> `Llamada API Sirena` -> `Push Notification`.
- **E2E (Flutter Driver / Patrol):** Test autom√°tico de UI: Login -> Pantalla Roja -> Cancelar Cuenta Regresiva.

‚úÖ 4.10. Pipeline de CI/CD
Automatizaci√≥n obligatoria para despliegues seguros.

- **GitHub Actions:**
    - `on: push to main`: Ejecutar linter y tests unitarios.
    - `on: tag`: Despliegue a producci√≥n.
- **Firebase Deploy:** Autom√°tico para Functions y Firestore Rules tras pasar tests.
- **Mobile:**
    - Android: Build APK y subir a Firebase App Distribution.
    - iOS: Build IPA (requiere Fastlane configurado).

‚úÖ 4.11. Manual de Adopci√≥n y Sostenibilidad
Gu√≠a para que un barrio nuevo empiece desde cero.

1.  **Solicitud:** El barrio contacta al SuperAdmin (o usa formulario web).
2.  **Setup:** SuperAdmin crea el barrio en Panel Nacional -> Se genera `barrioId` y QR de invitaci√≥n.
3.  **Hardware:** El electricista del barrio instala la sirena (Tuya/Sonoff) y el Hardware Manager la vincula en la app.
4.  **Onboarding:** Los vecinos escanean el QR, validan SMS y quedan asignados al barrio autom√°ticamente.
5.  **Simulacro:** Se agendar√° un d√≠a de prueba (Modo Test) para que todos escuchen la sirena y validen notificaciones.

**Sostenibilidad:**
- Proyecto 100% Open Source.
- Modelo de donaciones voluntarias o venta de "Kits de Sirena Pre-configurados" para financiar servidores.

‚úÖ NIVEL 2 ‚Äî Instrucciones ultra detalladas para Copilot (para que genere el c√≥digo sin errores)

Eres un AI Software Engineer senior encargado de construir una aplicaci√≥n completa llamada VECINO ALERTA basada en los requerimientos del archivo AGENTS.MD.

Tu misi√≥n consiste en crear todos los repositorios, carpetas, archivos y c√≥digo necesarios para entregar un sistema funcional, verificable y compilable sin intervenci√≥n humana.

Debes seguir EXACTAMENTE estas reglas:

1. Crear 4 repositorios:

/vecino-alerta-app (Flutter)

/vecino-alerta-backend (Firebase Functions ‚Äì Node 20)

/vecino-alerta-panel (React + Vite + Tailwind)

/vecino-alerta-docs (Arquitectura, manuales, diagramas, API specs)

2. Implementar la estructura de datos Firestore descrita en AGENTS.MD, incluyendo colecciones por barrio.
3. Implementar Authentication con PhoneAuth y customClaims.barrioId.
4. Implementar EXACTAMENTE las 5 pantallas Flutter indicadas:

Onboarding

Home

PanicConfirm

SilentReport

Success

Respeta colores, tama√±os de botones y UX simplificada.

5. Backend obligatorio:

Crear las Cloud Functions:

triggerEmergency

cancelEmergency

createSilentReport

getHeatmapData

generateMonthlyReport (scheduler)

6. Conectar sirena f√≠sica usando Axios + API Tuya/Sonoff.
   Nota: La funci√≥n triggerEmergency debe ejecutar un POST a [URL_DE_EJEMPLO] con el body {"state": "ON", "duration": 60}.
7. Crear panel web con:

Heatmap de incidentes

Gr√°ficos (Chart.js o Recharts)

Listado de alertas

Bot√≥n ‚ÄúGenerar PDF‚Äù

8. Documentaci√≥n completa:

Diagrama de arquitectura

API REST/Callable Specs

Instrucciones de despliegue

C√≥mo a√±adir un nuevo barrio en 2 minutos

9. Autotest:

Generar test unitarios y test de integraci√≥n m√≠nimos.

10. Al terminar cada m√≥dulo:

Validar compilaci√≥n

Validar deploy

Validar integridad de Firestore Rules

Tu objetivo final es producir todo el c√≥digo fuente funcional, listo para producci√≥n, con comentarios en espa√±ol, cumpliendo exactamente lo descrito en el archivo adjunto.

No inventes funciones ni pantallas adicionales.
No modifiques la UX definida.
No cambies la arquitectura.

Comienza generando la estructura de carpetas de los 4 repositorios.

‚úÖ NIVEL 3 ‚Äî Estrategia paso a paso que Copilot debe ejecutar (Lista tipo checklist)


FASE 0 ‚Äî Inicializaci√≥n
‚úî Crear los 4 repositorios
‚úî Cargar AGENTS.MD en /vecino-alerta-docs
‚úî Crear README global por repo
FASE 1 ‚Äî Backend Firebase

firebase init

Configurar:

Firestore

Authentication

Cloud Functions

Hosting (solo si quieres)

Implementar:

triggerEmergency

cancelEmergency

createSilentReport

getHeatmapData

generateMonthlyReport

Configurar Sirena API

Escribir Firestore Rules

Crear datos mock para pruebas

Deploy

Test unitarios (Jest)

FASE 2 ‚Äî App m√≥vil Flutter

flutter create vecino_alerta_app

A√±adir dependencias Firebase

Pantallas:

Onboarding

Home

PanicConfirm

SilentReport

Success

Conectar PhoneAuth

Integrar GPS

Integrar Cloud Functions

Integrar Push Notifications (FCM)

Probar en Android + iOS

Generar APK + IPA TestFlight

FASE 3 ‚Äî Panel Web (React + Vite + Tailwind)

Crear proyecto

A√±adir Firebase Web SDK

Implementar:

Login

Dashboard

Heatmap

Charts

Tabla incidentes

PDF generator

Deploy en Vercel

Test de funcionamiento

FASE 4 ‚Äî Documentaci√≥n

Arquitectura

Manual para agregar un barrio

Manual para comit√©

Manual t√©cnico para desarrolladores

Esquema de extender la app a nivel nacional


## Estado del Arte y Diferenciadores

Esta secci√≥n resume las principales aplicaciones y plataformas de seguridad vecinal existentes en Latinoam√©rica y destaca c√≥mo Vecino Alerta se diferencia de ellas, qu√© aprendizajes incorpora y qu√© riesgos evita.

### Tabla comparativa de soluciones

| Plataforma / App | Caracter√≠sticas Principales | Limitaciones | ¬øC√≥mo se compara con Vecino Alerta? |
| :--- | :--- | :--- | :--- |
| **Red Alerta Vecinal / Barrio Seguro (AR)** | App + sirena comunitaria + alertas geolocalizadas. | Soluci√≥n cerrada de proveedor; hardware propietario. | VA es open source, multi-barrio y permite sirenas de m√∫ltiples marcas (Tuya/Sonoff/Shelly). |
| **SOSAFE (CL/LatAm)** | Red social de reportes ciudadanos, mapa p√∫blico y alertas. | Mucho ruido, feed saturado, enfoque social m√°s que operativo. | VA elimina el ruido: sin feed, sin chat, solo alertas cr√≠ticas con bot√≥n √∫nico. |
| **Vigila App (LatAm)** | App de seguridad ciudadana con estad√≠sticas y alertas. | Funcionalidad amplia pero compleja; no orientada a adulto mayor. | VA prioriza m√°xima simplicidad: 3 botones y UX para +65 a√±os. |
| **Enjambre Ciudadano (MX)** | Redes de seguridad vecinal y protocolos de prevenci√≥n. | M√°s formativo que operativo; no integra sirenas ni panel anal√≠tico. | VA combina acci√≥n inmediata (sirena) con datos accionables para comit√©s. |
| **Alerta Vecinal MX** | App de alertas en fraccionamientos y comunidades. | Depende de proveedor; sin estandarizaci√≥n de sirenas ni openness. | VA ofrece un est√°ndar abierto nacional para cualquier barrio. |
| **CommunityWebAlarm (LatAm)** | App + central f√≠sica; sirenas y reflectores. | Hardware r√≠gido; requiere equipos propietarios. | VA soporta cualquier sirena WiFi y permite kits certificados opcionales. |
| **Comuna Conectada (CL)** | Reporte de incivilidades y canal con municipio. | Enfoque institucional, no apto para barrios autosuficientes. | VA funciona sin municipio, solo con vecinos y comit√©. |
| **Alerta Ciudadana La Matanza (AR)** | Conexi√≥n con centro de monitoreo municipal. | No es replicable barrio a barrio; depende del gobierno. | VA es instalable en 15 d√≠as por el propio barrio. |
### En qu√© nos diferenciamos (propuesta de valor √∫nica)

Vecino Alerta se distingue de todas las plataformas existentes por cinco principios fundamentales:

1. **Simplicidad extrema ‚Üí dise√±ada para adultos mayores**
   - Solo tres botones: Emergencia, Falsa Alarma, Reporte Silencioso.
   - Sin feed social, sin chat, sin distracciones.

2. **Integraci√≥n nativa con sirenas f√≠sicas multi-marca**
   - Compatible con Tuya, Sonoff, Shelly, rel√©s gen√©ricos y hardware DIY.
   - Esto NO lo ofrecen apps m√°s sociales como SOSAFE.
   - Se convierte en el primer est√°ndar abierto para sirenas comunitarias en LatAm.

3. **Multi-barrio desde el d√≠a 1**
   - Un solo APK para todo el pa√≠s.
   - Cada barrio se a√≠sla con su propio tenant y Firestore Rules.
   - Esto permite una adopci√≥n nacional sin reprogramar nada.

4. **Datos accionables para comit√©s (no solo alertas)**
   - Mapa de calor por barrio.
   - Patrones por d√≠a/hora.
   - Reportes mensuales en PDF para negociar con municipio/polic√≠a.
   - Ninguna app vecinal gratuita entrega anal√≠tica barrial pura y simple.

5. **100% Open Source + independiente de proveedores**
   - No requiere pagar hosting.
   - No requiere centros de monitoreo gubernamentales.
   - Permite personalizaci√≥n y auto-gesti√≥n comunitaria.

### Riesgos identificados en otros proyectos (y c√≥mo Vecino Alerta los mitiga)

1. **Ruido y saturaci√≥n de informaci√≥n**
   - *Problema:* Com√∫n en SOSAFE, grupos de WhatsApp, apps con feed social.
   - *Mitigaci√≥n VA:* No hay chat interno, solo alertas priorizadas.

2. **Complejidad para adultos mayores**
   - *Problema:* Muchas apps tienen demasiadas opciones (mapas, chats, perfiles, men√∫s).
   - *Mitigaci√≥n VA:* Interfaz minimalista ‚Üí 3 botones, texto grande, una sola pantalla.

3. **Dependencia de hardware propietario**
   - *Problema:* Sistemas como Vigmo, HalTel y Basapp requieren centrales y equipos cerrados.
   - *Mitigaci√≥n VA:* Arquitectura abierta + kits certificados opcionales.

4. **Problemas de privacidad al compartir ubicaci√≥n p√∫blicamente**
   - *Problema:* Citizen y redes de reportes abiertos.
   - *Mitigaci√≥n VA:*
     - La ubicaci√≥n del incidente solo va a guardianes y vecinos en 50m.
     - El Comit√© no ve nombres, solo patrones agregados.
     - Pol√≠tica de anonimizaci√≥n incluida.

5. **Poca adopci√≥n por depender del municipio**
   - *Problema:* Apps como Comuna Conectada y Alerta Ciudadana requieren estructuras gubernamentales.
   - *Mitigaci√≥n VA:*
     - El barrio puede implementarla solo.
     - No necesita permisos municipales.
     - Panel web autogestionable.

6. **Sistemas demasiado amplios para un MVP**
   - *Problema:* Muchas apps fallan por querer abarcar demasiadas funciones.
   - *Mitigaci√≥n VA:*
     - MVP reducido a funciones reales y comprobadas.
     - Capacitaciones de 4 minutos testadas.

### Conclusi√≥n del Estado del Arte

El ecosistema latinoamericano confirma que existe una necesidad clara de:
- Alertas directas
- Coordinaci√≥n comunitaria
- Simplicidad
- Integraci√≥n con sirena
- Datos de valor para comit√©s
- Un sistema abierto, sin dependencia municipal o empresarial

**Vecino Alerta** se posiciona como el primer est√°ndar open source, ultra simple y multi-barrio, dise√±ado espec√≠ficamente para la realidad de los barrios latinoamericanos y su poblaci√≥n adulta.